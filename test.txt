// ==UserScript==
// @name         React Localhost Automation Script (Label-based)
// @version      2.0
// @description  Automates filling fields, fetch/post cycles, and repeats for React apps using label-based targeting
// ==/UserScript==

(async () => {
  console.log("ðŸš€ Automation started...");

  // ===============================
  // âš™ï¸ CONFIGURATION SECTION
  // ===============================
  const config = {
    iterations: 3,               // ðŸ” Number of total iterations
    delayBetweenSteps: 1500,     // ðŸ• Wait between steps (ms)
    defaultValues: {
      poNumber: "4000003126",
      vehicleInTime: "08:30",
      vehicleNo: "MH12AB1234",
      supplierInvoice: "1234567890",
      lrNo: "LR00000000000123",
    },
    rowQuantityValue: "10.000",  // Default quantity for all rows
    labels: {                    // ðŸ·ï¸ Labels exactly as visible in your app
      poNumber: "PO Number",
      vehicleInTime: "Vehicle In Time",
      vehicleNo: "Vehicle No",
      supplierInvoice: "Supplier Challan/Invoice No.",
      lrNo: "LR No",
    },
    selectors: {                 // Adjust these as per your page
      fetchBtn: "#fetch",
      selectAllBtn: ".btn.btn-secondary.btn-sm",
      postBtn: "#postBtn",
      closePopup: ".modal .btn-close, .modal .btn-danger, .modal .btn-success",
      quantityField: 'input[id="quantity"]',
    },
  };

  // ===============================
  // ðŸ§© HELPER FUNCTIONS
  // ===============================

  const wait = (ms) => new Promise((res) => setTimeout(res, ms));

  const waitForElement = async (selector, timeout = 8000) => {
    const start = Date.now();
    while (Date.now() - start < timeout) {
      const el = document.querySelector(selector);
      if (el) return el;
      await wait(200);
    }
    console.warn(`â³ Timeout waiting for ${selector}`);
    return null;
  };

  const click = (selector) => {
    const el = document.querySelector(selector);
    if (el) {
      el.dispatchEvent(new MouseEvent("click", { bubbles: true, cancelable: true, view: window }));
      console.log(`ðŸ–±ï¸ Clicked ${selector}`);
    } else {
      console.warn(`âŒ Could not find element: ${selector}`);
    }
  };

  const closePopupIfOpen = () => {
    const closeBtn = document.querySelector(config.selectors.closePopup);
    if (closeBtn) {
      closeBtn.dispatchEvent(new MouseEvent("click", { bubbles: true, cancelable: true, view: window }));
      console.log("âœ… Popup closed");
    }
  };

  const fillByLabel = (labelText, value) => {
    const label = Array.from(document.querySelectorAll("label"))
      .find((l) => l.textContent.trim().includes(labelText));

    if (!label) {
      console.warn(`âš ï¸ Label not found: ${labelText}`);
      return;
    }

    const input = label.parentElement.querySelector("input, select, textarea");
    if (!input) {
      console.warn(`âš ï¸ Input not found for label: ${labelText}`);
      return;
    }

    // React-safe value setting
    const setter = Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype, "value").set;
    setter.call(input, value);
    input.dispatchEvent(new Event("input", { bubbles: true }));
    input.dispatchEvent(new Event("change", { bubbles: true }));

    console.log(`âœï¸ Filled "${labelText}" = ${value}`);
  };

  const fillTableRows = (value) => {
    const rows = document.querySelectorAll(config.selectors.quantityField);
    if (!rows.length) {
      console.warn("âš ï¸ No rows found in table");
      return;
    }

    rows.forEach((input) => {
      const setter = Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype, "value").set;
      setter.call(input, value);
      input.dispatchEvent(new Event("input", { bubbles: true }));
      input.dispatchEvent(new Event("change", { bubbles: true }));
    });
    console.log(`âœ… Filled ${rows.length} row(s) with quantity = ${value}`);
  };

  // ===============================
  // ðŸ§  MAIN LOOP
  // ===============================
  for (let i = 1; i <= config.iterations; i++) {
    console.log(`\nðŸ” Iteration ${i}/${config.iterations}`);

    // Step 1ï¸âƒ£ Fill first 5 fields by label
    fillByLabel(config.labels.poNumber, config.defaultValues.poNumber);
    fillByLabel(config.labels.vehicleInTime, config.defaultValues.vehicleInTime);
    fillByLabel(config.labels.vehicleNo, config.defaultValues.vehicleNo);
    fillByLabel(config.labels.supplierInvoice, config.defaultValues.supplierInvoice);
    fillByLabel(config.labels.lrNo, config.defaultValues.lrNo);

    await wait(config.delayBetweenSteps);

    // Step 2ï¸âƒ£ Click Fetch
    click(config.selectors.fetchBtn);
    await wait(config.delayBetweenSteps * 2);

    // Step 3ï¸âƒ£ Close any popup
    closePopupIfOpen();
    await wait(config.delayBetweenSteps);

    // Step 4ï¸âƒ£ Fill quantity for all rows
    fillTableRows(config.rowQuantityValue);
    await wait(config.delayBetweenSteps);

    // Step 5ï¸âƒ£ Select all rows
    click(config.selectors.selectAllBtn);
    await wait(config.delayBetweenSteps);

    // Step 6ï¸âƒ£ Click Post
    click(config.selectors.postBtn);
    await wait(config.delayBetweenSteps * 2);

    // Step 7ï¸âƒ£ Close popup after post
    closePopupIfOpen();
    await wait(config.delayBetweenSteps);

    // Step 8ï¸âƒ£ Increment last two fields for next iteration
    config.defaultValues.supplierInvoice = String(Number(config.defaultValues.supplierInvoice) + 1);
    config.defaultValues.lrNo = "LR" + String(Number(config.defaultValues.lrNo.replace(/\D/g, "")) + 1).padStart(14, "0");

    console.log(`ðŸ†• Updated for next round â†’ Invoice: ${config.defaultValues.supplierInvoice}, LR: ${config.defaultValues.lrNo}`);

    await wait(config.delayBetweenSteps);
  }

  console.log("ðŸŽ‰ All iterations completed successfully!");
})();

//-------------------------------------------------------------------------
// ==UserScript==
// @name         React Localhost Automation Script (Label-based, PO Incremental)
// @version      2.1
// @description  Automates filling fields, fetch/post cycles, and repeats for React apps using label-based targeting with PO auto-increment
// ==/UserScript==

(async () => {
  console.log("ðŸš€ Automation started...");

  // ===============================
  // âš™ï¸ CONFIGURATION SECTION
  // ===============================
  const config = {
    startPONumber: 4000003145,    // ðŸ”¢ Starting PO number
    endPONumber: 4000003160,      // ðŸ”¢ Ending PO number
    delayBetweenSteps: 1500,      // ðŸ• Wait between steps (ms)
    defaultValues: {
      vehicleInTime: "08:30",
      vehicleNo: "MH12AB1234",
      supplierInvoice: "1234567890",
      lrNo: "LR00000000000123",
    },
    rowQuantityValue: "10.000",   // Default quantity for all rows
    labels: {                     // ðŸ·ï¸ Labels exactly as visible in your app
      poNumber: "PO Number",
      vehicleInTime: "Vehicle In Time",
      vehicleNo: "Vehicle No",
      supplierInvoice: "Supplier Challan/Invoice No.",
      lrNo: "LR No",
    },
    selectors: {                  // Adjust these as per your page
      fetchBtn: "#fetch",
      selectAllBtn: ".btn.btn-secondary.btn-sm",
      postBtn: "#postBtn",
      closePopup: ".modal .btn-close, .modal .btn-danger, .modal .btn-success",
      quantityField: 'input[id="quantity"]',
    },
  };

  // ===============================
  // ðŸ§© HELPER FUNCTIONS
  // ===============================
  const wait = (ms) => new Promise((res) => setTimeout(res, ms));

  const waitForElement = async (selector, timeout = 8000) => {
    const start = Date.now();
    while (Date.now() - start < timeout) {
      const el = document.querySelector(selector);
      if (el) return el;
      await wait(200);
    }
    console.warn(`â³ Timeout waiting for ${selector}`);
    return null;
  };

  const click = (selector) => {
    const el = document.querySelector(selector);
    if (el) {
      el.dispatchEvent(new MouseEvent("click", { bubbles: true, cancelable: true, view: window }));
      console.log(`ðŸ–±ï¸ Clicked ${selector}`);
    } else {
      console.warn(`âŒ Could not find element: ${selector}`);
    }
  };

  const closePopupIfOpen = () => {
    const closeBtn = document.querySelector(config.selectors.closePopup);
    if (closeBtn) {
      closeBtn.dispatchEvent(new MouseEvent("click", { bubbles: true, cancelable: true, view: window }));
      console.log("âœ… Popup closed");
    }
  };

  const fillByLabel = (labelText, value) => {
    const label = Array.from(document.querySelectorAll("label"))
      .find((l) => l.textContent.trim().includes(labelText));

    if (!label) {
      console.warn(`âš ï¸ Label not found: ${labelText}`);
      return;
    }

    const input = label.parentElement.querySelector("input, select, textarea");
    if (!input) {
      console.warn(`âš ï¸ Input not found for label: ${labelText}`);
      return;
    }

    // React-safe input assignment
    const setter = Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype, "value").set;
    setter.call(input, value);
    input.dispatchEvent(new Event("input", { bubbles: true }));
    input.dispatchEvent(new Event("change", { bubbles: true }));

    console.log(`âœï¸ Filled "${labelText}" = ${value}`);
  };

  const fillTableRows = (value) => {
    const rows = document.querySelectorAll(config.selectors.quantityField);
    if (!rows.length) {
      console.warn("âš ï¸ No rows found in table");
      return;
    }

    rows.forEach((input) => {
      const setter = Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype, "value").set;
      setter.call(input, value);
      input.dispatchEvent(new Event("input", { bubbles: true }));
      input.dispatchEvent(new Event("change", { bubbles: true }));
    });
    console.log(`âœ… Filled ${rows.length} row(s) with quantity = ${value}`);
  };

  // ===============================
  // ðŸ§  MAIN LOOP
  // ===============================
  for (let po = config.startPONumber; po <= config.endPONumber; po++) {
    console.log(`\nðŸ” Processing PO: ${po}`);

    // Step 1ï¸âƒ£ Fill form fields
    fillByLabel(config.labels.poNumber, String(po));
    fillByLabel(config.labels.vehicleInTime, config.defaultValues.vehicleInTime);
    fillByLabel(config.labels.vehicleNo, config.defaultValues.vehicleNo);
    fillByLabel(config.labels.supplierInvoice, config.defaultValues.supplierInvoice);
    fillByLabel(config.labels.lrNo, config.defaultValues.lrNo);

    await wait(config.delayBetweenSteps);

    // Step 2ï¸âƒ£ Click Fetch
    click(config.selectors.fetchBtn);
    await wait(config.delayBetweenSteps * 2);

    // Step 3ï¸âƒ£ Close popup if it appears
    closePopupIfOpen();
    await wait(config.delayBetweenSteps);

    // Step 4ï¸âƒ£ Fill row quantities
    fillTableRows(config.rowQuantityValue);
    await wait(config.delayBetweenSteps);

    // Step 5ï¸âƒ£ Select all
    click(config.selectors.selectAllBtn);
    await wait(config.delayBetweenSteps);

    // Step 6ï¸âƒ£ Click Post
    click(config.selectors.postBtn);
    await wait(config.delayBetweenSteps * 2);

    // Step 7ï¸âƒ£ Close popup after posting
    closePopupIfOpen();
    await wait(config.delayBetweenSteps);

    // Step 8ï¸âƒ£ Increment last two fields for next PO
    config.defaultValues.supplierInvoice = String(Number(config.defaultValues.supplierInvoice) + 1);
    config.defaultValues.lrNo =
      "LR" + String(Number(config.defaultValues.lrNo.replace(/\D/g, "")) + 1).padStart(14, "0");

    console.log(`ðŸ†• Next round ready â†’ Invoice: ${config.defaultValues.supplierInvoice}, LR: ${config.defaultValues.lrNo}`);
    await wait(config.delayBetweenSteps);
  }

  console.log("ðŸŽ‰ All PO numbers processed successfully!");
})();
